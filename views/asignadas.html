<section class="uk-section">
    <div class="uk-container">
        <div class="uk-overflow-auto">
            <table class="uk-table uk-table-hover uk-table-middle uk-table-divider">
                <thead>
                <tr>
                    <th class="uk-width-1-4@m uk-width-1-2">Titulo</th>
                    <th class="uk-table-expand uk-visible@m">Descripción</th>
                    <th class="uk-width-small">Estado</th>
                    <th class="uk-width-small uk-text-center"></th>
                </tr>
                </thead>
                <tbody>
                {{#each tareas}}
                <tr>
                    <td>{{ titulo }}</td>
                    <td class="uk-visible@m">{{ descripcion }}</td>
                    <td>
                        {{#isAsignada estado}}
                            <p class="uk-text-uppercase uk-text-primary">Asignada</p>
                        {{/isAsignada}}

                        {{#isInProgress estado}}
                            <p class="uk-text-uppercase uk-text-warning">En progreso</p>
                        {{/isInProgress}}

                        {{#isFinished estado}}
                            <p class="uk-text-uppercase uk-text-success">Finalizada</p>
                        {{/isFinished}}
                    </td>
                    <script>let urlBase = {}</script>
                    <td>
                        {{#isInList id ../tareasSeguidas }}
                            <div id="container-{{id}}" style="margin: auto; width: fit-content">
                                <button style="min-width: 85px;" data-uk-icon="bookmark" id="seguir-{{id}}" class="uk-button uk-button-default uk-button-primary" type="button" uk-toggle="target: #seguir-{{id}}; cls: uk-button-primary;" >
                                </button>
                            </div>
                            <script>
                                urlBase["{{id}}"] = "no-favorita"
                            </script>
                    <!-- Mover el script abajo del todo y dejar solo uno y según si es favorita o no inicializar una variable (una variable por tarea) que diga al script por qué redirección empezar-->
                        {{else}}
                            <div id="container-{{id}}">
                                <button style="min-width: 85px;" data-uk-icon="bookmark" id="seguir-{{id}}" class="uk-button uk-button-default" type="button" uk-toggle="target: #seguir-{{id}}; mode:click; cls: uk-button-primary;"  >
                                </button>
                            </div>
                            <script>
                                urlBase["{{id}}"] = "favorita"
                            </script>

                        {{/isInList}}
                        <script>
                            $("#container-{{id}}").click(function() {
                                $.get( "/" + urlBase["{{id}}"] + "/{{ id }}", function( data ) {
                                    /* Para no perder la página en la que estamos guardamos el param page */
                                    var numberPage = "{{../valor}}";
                                    var urlUpdate = '/asignadas';
                                    urlUpdate += "?pg="+numberPage;
                                    $("#container-{{id}}").load(urlUpdate + " #seguir-{{id}}");
                                    console.log(data)
                                    // Si ha habido un fallo al contactar con la BD y el controlador devolvió false, avisar:
                                    if (data === false)
                                        UIkit.notification({message: '<span uk-icon=\'icon: info\'></span> Ha habido un error procesando su petición', status: "danger", pos: 'top-right'});
                                    // Siempre cambiar el comportamiento del boton para que sa consistente con la vista
                                    if (urlBase["{{id}}"].localeCompare("favorita") === 0) {
                                        urlBase["{{id}}"] = "no-favorita";
                                        // Si se pudo contactar con BD, notificar la operacion
                                        if (data === true){
                                            UIkit.notification({
                                                message: '<span uk-icon=\'icon: plus\'></span> Incidencia añadida a seguimiento',
                                                status: "primary",
                                                pos: 'top-right'
                                            });
                                        }
                                    }
                                    else {
                                        urlBase["{{id}}"] = "favorita";
                                        // Si se pudo contactar con BD, notificar la operacion
                                        if (data === true){
                                            UIkit.notification({message: '<span uk-icon=\'icon: close\'></span> Incidencia eliminada de seguimiento', status: "primary", pos: 'top-right'})
                                        }
                                    }

                                }).fail(function () { // Si no se pudo hacer la peticion HTTP, avisar:
                                    UIkit.notification({message: '<span uk-icon=\'icon: info\'></span> Ha habido un error procesando su petición', status: "danger", pos: 'top-right'});
                            })
                            })
                        </script>
                    </td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <ul class="uk-pagination uk-flex-center" uk-margin>
            {{#ifGreaterThanOne valor}}
                <li>
                    <a href="/asignadas?pg={{ restar valor 1 }}">{{ restar valor 1 }}</a>
                </li>
            {{/ifGreaterThanOne}}
            <li class="uk-active">
                <a href="/asignadas?pg={{ valor }}">{{ valor }}</a>
            </li>
            <li>
                <a href="/asignadas?pg={{ sumar valor 1 }}">{{ sumar valor 1 }}</a>
            </li>

        </ul>

    </div>
</section>
